version: '3.9'

services:
  roze-db:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: rozecare
    ports:
      - "5432:5432"
    volumes:
      - rozecare-db:/var/lib/postgresql/data

  roze-redis:
    image: redis:7
    ports:
      - "6379:6379"

  roze-storage:
    image: mcr.microsoft.com/azure-storage/azurite
    command: azurite-blob --blobHost 0.0.0.0
    ports:
      - "10000:10000"
      - "10001:10001"
    volumes:
      - rozecare-blob:/data

  roze-api:
    build:
      context: ..
      dockerfile: src/RozeCare.Api/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__Default: Host=roze-db;Port=5432;Database=rozecare;Username=postgres;Password=postgres
      Jwt__Authority: https://localhost
      Jwt__Audience: roze-api
      Jwt__SigningKey: local-development-signing-key-please-change
      Azure__Blob__ConnectionString: DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2f2Z==;BlobEndpoint=http://roze-storage:10000/devstoreaccount1;
      Azure__Blob__Container: roze-docs
      Redis__Connection: roze-redis:6379
    ports:
      - "5000:8080"
    depends_on:
      - roze-db
      - roze-redis
      - roze-storage

  roze-pwa:
    build:
      context: ../web/roze-pwa
      dockerfile: Dockerfile
    environment:
      VITE_API_BASE_URL: http://localhost:5000
    ports:
      - "5173:4173"
    depends_on:
      - roze-api

volumes:
  rozecare-db:
  rozecare-blob:
